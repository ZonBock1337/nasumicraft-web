<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Cyber Implant Secret</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />
  <style>
    body {
      background: #0f0f0f;
      color: #00ffcc;
      font-family: 'Press Start 2P', cursive;
      text-align: center;
    }

    .achievement-popup {
      position: fixed;
      top: 20px;
      left: 20px;
      background: #222;
      border: 2px solid #0ff;
      padding: 12px;
      font-size: 12px;
      box-shadow: 0 0 12px #0ff;
      display: none;
      z-index: 9999;
    }

    #discordPrompt {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #111;
      color: #0ff;
      padding: 20px;
      border: 2px solid #0ff;
      max-width: 90%;
      z-index: 9998;
    }

    input, button {
      font-family: monospace;
      margin-top: 10px;
    }

    #bg {
      margin-top: 60px;
      font-size: 18px;
      display: none;
    }
  </style>
</head>
<body>

<div class="achievement-popup" id="achievementPopup">
  <strong>Erfolg freigeschaltet!</strong><br />
  Cyber Implant<br />
  Musika
</div>

<div id="discordPrompt" style="display: none;">
  <p>Bitte gebe dein Discord @ ein:</p>
  <input type="text" id="discordInput" placeholder="@User#1234" />
  <br />
  <button onclick="saveDiscord()">Speichern</button>
  <br /><br />
  <label><input type="checkbox" id="noAsk" /> Nicht nochmal fragen</label>
  <p style="font-size: 10px;">Für seltene Erfolge erhältst du Discord-Rollen.</p>
</div>

<div id="bg">
  <h1>Cyber Implant aktiviert</h1>
  <p>Geheimnisvolle Energie strömt durch dein System...</p>
  <audio autoplay>
    <source src="https://mc.nasumicraft.de/secrets/sounds/brain-implant-music.mp3" type="audio/mpeg" />
  </audio>
</div>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  const urlID = urlParams.get("id");

  // UUID speichern oder laden
  if (!localStorage.getItem("uuid")) {
    const newID = crypto.randomUUID();
    localStorage.setItem("uuid", newID);
  }

  const storedID = localStorage.getItem("uuid");

  // ID vergleichen
  if (!urlID || urlID !== storedID) {
    window.location.href = "/secrets/access-denied.html";
  } else {
    document.getElementById("bg").style.display = "block";
    startFlow();
  }

  function showAchievement(title, desc) {
    const popup = document.getElementById("achievementPopup");
    popup.innerHTML = `<strong>Erfolg freigeschaltet!</strong><br>${title}<br>${desc}`;
    popup.style.display = "block";
    new Audio("https://www.minecraftsounds.com/minecraft/sfx/orb_pickup.mp3").play();
    setTimeout(() => {
      popup.style.display = "none";
    }, 5000);
  }

  function saveDiscord() {
    const tag = document.getElementById("discordInput").value.trim();
    if (!tag.startsWith("@")) {
      alert("Discord-Name muss mit @ beginnen.");
      return;
    }
    localStorage.setItem("discordTag", tag);
    if (document.getElementById("noAsk").checked) {
      localStorage.setItem("noAsk", "true");
    }
    document.getElementById("discordPrompt").style.display = "none";
    unlockAchievement();
  }

  function startFlow() {
    const noAsk = localStorage.getItem("noAsk") === "true";
    const discordTag = localStorage.getItem("discordTag");

    if (!discordTag && !noAsk) {
      document.getElementById("discordPrompt").style.display = "block";
    } else {
      unlockAchievement();
    }
  }

  function unlockAchievement() {
    if (!localStorage.getItem("cyber_implant")) {
      localStorage.setItem("cyber_implant", "true");
      showAchievement("Cyber Implant");

      const discordName = localStorage.getItem("discordTag") || "@Unbekannt";
      if (!localStorage.getItem("webhook_cyber_implant_sent")) {
        fetch("https://discord.com/api/webhooks/1367549168301772801/PFCvIE0GyAAEHYCXBkqdjSXbwu3R5Fm5fY0yMKiGKgEiFubrzGro9BaWn-CrQRhS9xGh", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            content: `${discordName} hat das Cyber Implant Achievement freigeschaltet! [Selten]`
          })
        }).then(() => {
          localStorage.setItem("webhook_cyber_implant_sent", "true");
        }).catch(console.error);
      }
    }
  }
</script>
</body>
</html>
